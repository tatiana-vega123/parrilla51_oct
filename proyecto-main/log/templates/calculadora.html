<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Orden Mesa {{ mesa }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Estructura para footer fijo */
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    main {
      flex: 1;
    }

    body { font-family: "Segoe UI", Tahoma, sans-serif; background:#3a3a3a; color:#f0f0f0; }
    .navbar { display:flex; justify-content:space-between; background:#2f2f2f; padding:12px 30px; }
    .logo { display:flex; align-items:center; gap:10px; font-size:22px; font-weight:bold; color:#ff4444; }
    .logo img { height:40px; }
    .nav-links { list-style:none; display:flex; gap:25px; margin:0; padding:0; }
    .nav-links li a { color:#fff; text-decoration:none; }
    .nav-links li a:hover { color:#ffd700; }
    .orden-container { padding:20px; }
    .orden-layout { display:flex; gap:30px; }
    .calculadora { background:#2f2f2f; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.4); width:350px; }
    .pantalla { background:#555; border-radius:8px; padding:12px; margin-bottom:20px; min-height:200px; }
    .producto-item { display:flex; justify-content:space-between; align-items:center; background:#444; padding:6px 10px; margin:5px 0; border-radius:6px; }
    .producto-item input { width:40px; text-align:center; margin-right:5px; }
    .total { margin-top:10px; font-weight:bold; font-size:16px; color:#ffd700; }

    /* Botones categorías estilo borde */
    .categorias { display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; }
    .categorias button {
      background:#3a3a3a;
      color:#fff;
      border:2px solid #ffd700;
      border-radius:10px;
      padding:10px 15px;
      font-weight:bold;
      transition:all 0.3s ease;
    }
    .categorias button:hover {
      border-color:#ff4444;
      background:#444;
      transform:scale(1.03);
    }

    /* Botones productos estilo borde */
    #productosArea button {
      display:block;
      width:100%;
      margin:5px 0;
      padding:12px;
      border:2px solid #ffd700;
      border-radius:10px;
      background:#3a3a3a;
      color:#fff;
      font-weight:bold;
      transition:all 0.3s ease;
    }
    #productosArea button:hover {
      border-color:#ff4444;
      background:#444;
      transform:scale(1.03);
    }

    /* Botones calculadora */
    .btn-success {
      background:#ffd700;
      color:#000;
      border:none;
    }
    .btn-success:hover { background:#e6b800; }
    .btn-danger {
      background:#ff4444;
      border:none;
    }
    .btn-danger:hover { background:#cc0000; }

    .alert-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1055;
    }

    /* Footer */
    footer {
      background: #2f2f2f;
      color: #fff;
      text-align: center;
      padding: 10px;
      border-top: 2px solid #ffd700;
      margin-top: auto; /* Esto asegura que el pie de página esté en la parte inferior */
    }
  </style>
  </head>
  <body>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="alert-container">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <nav class="navbar">
    <div class="logo">
      <img src="{{ url_for('static', filename='img/logooo.png') }}" alt="Logo">
      <span>Parrilla 51</span>
    </div>
    <ul class="nav-links">
      <li><a href="{{ url_for('mesas_empleado') }}">Mesas</a></li>
      <li><a href="{{ url_for('registrar_empleado') }}">Registrar</a></li>
      <li><a href="{{ url_for('ordenes_empleado') }}">Órdenes</a></li>
      <li><a href="{{ url_for('reservas_empleado') }}">Reservas</a></li>
    </ul>
  </nav>

  <main>
  <div class="orden-container">
    <h2>Orden para la Mesa {{ mesa }}</h2>
    <div class="orden-layout">
      <!-- CALCULADORA -->
      <div class="calculadora">
        <div class="pantalla">
          <div id="listaProductos"></div>
          <div class="total">Total: $<span id="total">0</span></div>
        </div>
        <button class="btn btn-success w-100" onclick="abrirPago()">Total a Pagar</button>

        <button class="btn btn-danger w-100 mt-2" onclick="borrarTodo()">Vaciar</button>
      </div>

      <!-- CATEGORÍAS + PRODUCTOS -->
      <div style="flex:1;">
        <div class="categorias">
          {% for c in categorias %}
            <button onclick="mostrarProductos({{ c.id_categoria }})">{{ c.nombre_categoria }}</button>
          {% endfor %}
        </div>
        <div id="productosArea"></div>
      </div>
    </div>
  </div>

  </main>

  <!-- MODAL PAGO -->
  <div class="modal fade" id="modalPago" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title">Pago de la Orden</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Total a pagar: <strong>$<span id="pagoTotal"></span></strong></p>
          <input type="number" id="dineroCliente" class="form-control" placeholder="Dinero recibido">
          <p class="mt-3">Cambio: <strong>$<span id="cambio"></span></strong></p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" onclick="calcularCambio()">Calcular Cambio</button>
          <button class="btn btn-primary" onclick="finalizarPago()">Finalizar</button> <!-- Nuevo botón -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Pago Realizado (emergente) -->
  <div class="modal fade" id="modalPagoRealizado" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title">Pago Realizado</h5>
        </div>
        <div class="modal-body">
          <p>El pago se ha realizado con éxito.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Mostrar el mensaje de "Pago realizado" y luego redirigir a la página
    function mostrarPagoRealizadoYRedirigir() {
      // Mostrar el modal de pago realizado
      let modalPagoRealizado = new bootstrap.Modal(document.getElementById("modalPagoRealizado"));
      modalPagoRealizado.show();

      // Después de 3 segundos, redirigir a la página de mesas
      setTimeout(function() {
        window.location.href = "{{ url_for('mesas_empleado') }}"; // Redirige a 'mesas_empleado'
      }, 3000); // 3000 ms = 3 segundos
    }

    // Llamar esta función cuando el pago sea finalizado correctamente
    mostrarPagoRealizadoYRedirigir();
    </script>



    <footer>
      © 2025 Parrilla 51 - Todos los derechos reservados
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>{
      let lista = [];
      let total = 0;

      const productosPorCategoria = {
        {% for c in categorias %}
          {{ c.id_categoria }}: [
            {% for p in productos if p.cod_categoria == c.id_categoria %}
              { id_producto: {{ p.id_producto }}, nombre: "{{ p.nombre }}", precio: {{ p.precio }} },
            {% endfor %}
          ],
        {% endfor %}
      };


      function mostrarProductos(idCat) {
        const contenedor = document.getElementById("productosArea");
        contenedor.innerHTML = "";
        productosPorCategoria[idCat].forEach(p => {
          const btn = document.createElement("button");
          btn.textContent = `${p.nombre} - $${p.precio}`;
          btn.onclick = () => agregarProducto(p.id_producto, p.nombre, p.precio);
          contenedor.appendChild(btn);
        });
      }

      function agregarProducto(idProducto, nombre, precio) {
        let item = lista.find(p => p.id_producto === idProducto);
        if (item) {
          item.cantidad++;
        } else {
          lista.push({ id_producto: idProducto, nombre, precio, cantidad: 1 });
        }
        renderLista();
      }

      function eliminarProducto(nombre) {
        lista = lista.filter(p => p.nombre !== nombre);
        renderLista();
      }

      function cambiarCantidad(nombre, nuevaCantidad) {
        let item = lista.find(p => p.nombre === nombre);
        if (item && nuevaCantidad > 0) {
          item.cantidad = nuevaCantidad;
        }
        renderLista();
      }

      function renderLista() {
        const listaDiv = document.getElementById("listaProductos");
        listaDiv.innerHTML = "";
        total = 0;

        lista.forEach(item => {
          total += item.precio * item.cantidad;
          const div = document.createElement("div");
          div.className = "producto-item";
          div.innerHTML = `
            <span>${item.nombre}</span>
            <input type="number" min="1" value="${item.cantidad}" onchange="cambiarCantidad('${item.nombre}', parseInt(this.value))">
            <span>$${(item.precio * item.cantidad).toLocaleString()}</span>
            <button onclick="eliminarProducto('${item.nombre}')">x</button>
          `;
          listaDiv.appendChild(div);
        });

        document.getElementById("total").textContent = total.toLocaleString();
      }


      function borrarTodo() {
        lista = [];
        total = 0;
        renderLista();
      }

      function abrirPago() {
        // Mostrar el modal
        let modal = new bootstrap.Modal(document.getElementById("modalPago"));
        modal.show();

        // Establecer el total en el formulario oculto
        document.getElementById("totalPago").value = total; // Establece el valor total

        // Establecer el total en el modal para que se muestre al usuario
        document.getElementById("pagoTotal").textContent = total.toLocaleString(); // Muestra el total en el modal
      }

      function calcularCambio() {
        let dinero = parseFloat(document.getElementById("dineroCliente").value);
        if (!isNaN(dinero) && dinero >= total) {
          let cambio = dinero - total;
          document.getElementById("cambio").textContent = cambio.toLocaleString();
        } else {
          // Si el dinero es inválido o insuficiente, muestra una alerta
          alert("El dinero recibido es insuficiente o inválido.");
        }
      }

      function finalizarPago() {
        // Obtener el dinero recibido
        let dinero = parseFloat(document.getElementById("dineroCliente").value);
        if (!isNaN(dinero) && dinero >= total) {
          // Si el dinero recibido es válido y suficiente
          let cambio = dinero - total;
          document.getElementById("cambio").textContent = cambio.toLocaleString();  // Mostrar el cambio
          
          // Enviar los datos al backend para registrar el pago
          document.getElementById("productosInput").value = JSON.stringify(lista);  // Productos en formato JSON
          document.getElementById("dineroClienteInput").value = dinero;  // Dinero recibido
          document.getElementById("totalPago").value = total;  // Total a pagar

          // Enviar el formulario al servidor
          document.getElementById("formPago").submit();

          // Mostrar el mensaje de pago realizado y redirigir después de 3 segundos
          mostrarPagoRealizadoYRedirigir();

          // Cerrar el modal
          let modalEl = document.getElementById("modalPago");
          let modal = bootstrap.Modal.getInstance(modalEl);
          modal.hide();
        } else {
          // Si el dinero recibido no es válido o no es suficiente
          alert("El dinero recibido es insuficiente o inválido.");
        }
      }
    }
  </script>

    <form id="formPago" action="{{ url_for('registrar_pago_restaurante') }}" method="POST" style="display: none;">
      <input type="hidden" name="id_mesa" value="{{ mesa }}">
      <input type="hidden" name="total" id="totalPago">
      <input type="hidden" name="dinero_cliente" id="dineroClienteInput">
      
      <!-- Enviar productos como JSON -->
      <input type="hidden" name="productos" id="productosInput">
    </form>


  </body>
</html>